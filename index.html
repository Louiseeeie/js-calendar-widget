<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.cdnfonts.com/css/qanelas" rel="stylesheet">
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js'></script>
  <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/google-calendar@6.1.19/index.global.min.js"></script>

</head>
<body>
  <div class="container">
    <div class="calendar-container">
       <div id="calendar" class="calendar"></div>
    </div>
  </div>

  <script>
   document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        // Helper: does an event overlap the current day?
        function eventOccursOnDate(ev, date) {
          var y = date.getFullYear(), m = date.getMonth(), d = date.getDate();
          var dayStart = new Date(y, m, d, 0, 0, 0, 0);
          var dayEnd = new Date(y, m, d, 23, 59, 59, 999);
          var start = ev.start;
          var end = ev.end || ev.start;
          return start <= dayEnd && end >= dayStart;
        }

        // Ensure a "no events" message element exists inside the day's event area
        function ensureNoEventsEl() {
          var dayEventsContainer = calendarEl.querySelector('.fc-daygrid-day-events');
          if (!dayEventsContainer) return null;
          var msg = dayEventsContainer.querySelector('.no-events-message');
          if (!msg) {
            msg = document.createElement('div');
            msg.className = 'no-events-message';
            msg.innerText = 'No Junior School Events today';
            dayEventsContainer.appendChild(msg);
          }
          return msg;
        }

        var calendar = new FullCalendar.Calendar(calendarEl, {
          initialView: 'dayGridDay',
          headerToolbar: {
            left: 'title',     
            center: '',
            right: ''    
          },
          googleCalendarApiKey: 'AIzaSyBGUY5IcAf1AXNWcWZMeb8LKSRQXIIbxKk',
          events: {
            googleCalendarId: '3udh9bqofvrth46lhlbacp0r2kq18hv2%40import.calendar.google.com&ctz=Australia%2FPerth'
          },

          eventClick: function(info) {
            // stop FullCalendar from following the event's default URL
            info.jsEvent.preventDefault();
            // open paperly
            window.open('https://sth.paperlyapp.com/public/calendar', '_blank');
          },
          
          eventContent: function(arg) {
          // create a container div and force vertical layout
          let container = document.createElement('div');
          container.style.display = 'flex';
          container.style.flexDirection = 'column'; 
          container.style.alignItems = 'flex-start'; 

          let titleEl = document.createElement('div');
          titleEl.innerText = arg.event.title;
          
          // Format time
          let start = arg.event.start;
          let end = arg.event.end;

          function formatTime(date) {
            if (!date) return '';
            let hours = date.getHours();
            let minutes = date.getMinutes();
            let ampm = hours >= 12 ? 'pm' : 'am';
            hours = hours % 12;
            if (hours === 0) hours = 12;
            return hours + ':' + (minutes < 10 ? '0' + minutes : minutes) + ampm;
          }

          let timeEl = document.createElement('div');
          timeEl.innerText = formatTime(start) + (end ? ' - ' + formatTime(end) : '');

          // Removed incorrect check: if (!title) return "no";
          container.appendChild(timeEl);
          container.appendChild(titleEl);
            
          return { domNodes: [container] };
        },

        // NEW: update message when events or dates change
        eventsSet: function() {
          updateNoEventsMessage();
        },
        datesSet: function() {
          // wait for DOM update before checking
          setTimeout(updateNoEventsMessage, 0);
        }
      });

      function updateNoEventsMessage() {
        var msgEl = ensureNoEventsEl();
        if (!msgEl) return;
        var events = calendar.getEvents();
        var currentDate = calendar.getDate();
        var hasEvent = events.some(function(ev) { return eventOccursOnDate(ev, currentDate); });
        msgEl.style.display = hasEvent ? 'none' : 'block';
      }

      calendar.render();
      updateNoEventsMessage();
    });

  </script>
</body>
</html>
